<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carte des prestataires</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #map { height: 500px; margin-top: 20px; }
    #resultat { margin-top: 10px; font-size: 18px; }
    input { padding: 5px; font-size: 14px; }
    button { padding: 6px 12px; font-size: 14px; margin-left: 5px; cursor: pointer; }
  </style>
</head>
<body>

<h2>Chercher un prestataire</h2>
<input id="adresse" type="text" placeholder="Adresse du client" style="width:300px;">
<button onclick="chercher()">Chercher</button>

<div id="resultat"></div>
<div id="map"></div>

<script>
  // Carte Leaflet centrée sur la France
  const map = L.map('map').setView([46.5, 2.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let marker = null;

  // Prestataires par code département
  const prestatairesParCode = {
    "01": null,
    "02": "Univers bureau 69",
    "03": null,
    "04": "DS transport 13",
    "05": "DS transport 13",
    "06": "DS transport 13",
    "07": null,
    "08": "Ctm Bureautique",
    "09": "DS Transport 31",
    "10": "Ctm Bureautique",
    "11": "DS Transport 31",
    "12": "DS Transport 31",
    "13": "DS transport 13",
    "14": "LTM 14",
    "16": "TS express",
    "17": "TS express",
    "22": "LTM 56",
    "24": "TS express",
    "29": "LTM 56",
    "30": "DS transport 13",
    "31": "DS Transport 31",
    "32": "DS Transport 31",
    "33": "TS express",
    "34": "DS transport 13",
    "35": "LTM 56",
    "40": "TS express",
    "44": "LTM 44",
    "47": "TS express",
    "49": "LTM 44",
    "50": "LTM 14",
    "53": "LTM 44",
    "56": "LTM 56",
    "59": "LTM 59",
    "60": "Univers bureau 69",
    "61": "LTM 14",
    "62": "Univers bureau 69, LTM 59",
    "64": "TS express",
    "65": "DS Transport 31",
    "66": "DS Transport 31",
    "69": "Univers bureau 69",
    "75": "Tannous/ Dryft",
    "77": "Tannous/ Dryft",
    "78": "Tannous/ Dryft",
    "80": "Univers bureau 69, LTM 59",
    "91": "Univers bureau 69",
    "92": "Tannous/ Dryft",
    "93": "Tannous/ Dryft",
    "94": "Tannous/ Dryft",
    "95": "Univers bureau 69"
    // Compléter les autres codes si nécessaire
  };

  async function chercher() {
    const adresse = document.getElementById("adresse").value.trim();
    if (!adresse) return;

    const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(adresse)}&limit=1`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data.features.length) {
      document.getElementById("resultat").innerText = "Adresse introuvable.";
      return;
    }

    const feature = data.features[0];
    const coords = feature.geometry.coordinates; // [lon, lat]
    const codeInsee = feature.properties.citycode; // ex: "75056"
    const departementCode = codeInsee.substring(0, 2); // "75" pour Paris

    const presta = prestatairesParCode[departementCode] || "Aucun prestataire pour ce département.";

    document.getElementById("resultat").innerHTML =
      `Département (code) : <b>${departementCode}</b><br>` +
      `Prestataire : <b>${presta}</b>`;

    if (marker) map.removeLayer(marker);
    marker = L.marker([coords[1], coords[0]]).addTo(map);
    // Pas de zoom automatique
  }
</script>

</body>
</html>
